const Settings = ({
    show,
    onClose,
    unlockedAchievements,
    achievementsData,
    onExportData,
    onImportData,
    onResetAllData,
    onToggleTheme,
    viewMode,
    onViewModeChange,
    isMobileView,
    isTabletView,
    onUnlockAchievement,
    onOpenProfileGenerator,
    onIncrementAboutPageOpen
}) => {
    const { useState, useEffect } = React;
    const [activeSettingsTab, setActiveSettingsTab] = useState('achievements');
    const [activeAchievementTab, setActiveAchievementTab] = useState('all');
    const [mailSubject, setMailSubject] = useState('‰∏çÂÖ∑ÂêàÂ†±Âëä');

    useEffect(() => {
        if (activeSettingsTab === 'about') {
            onIncrementAboutPageOpen();
        }
    }, [activeSettingsTab]);

    if (!show) {
        return null;
    }

    const achievementCategories = { all: '„Åô„Åπ„Å¶', progress: 'ÈÄ≤Ë°åÂ∫¶', collection: 'ÂèéÈõÜ', battle: 'Êà¶Èóò', feature: 'Ê©üËÉΩ', secret: 'ÁßòÂØÜ' };

    const achievementsArray = Object.values(achievementsData);
    const visibleAchievements = achievementsArray.filter(ach => {
        if (isMobileView && ach.type === 'private') {
            return false;
        }
        if (activeAchievementTab !== 'all' && ach.category !== activeAchievementTab) {
            if (ach.type === 'secret' && activeAchievementTab !== 'secret') return false;
            if (ach.type !== 'secret' && activeAchievementTab === 'secret') return false;
            if (activeAchievementTab !== 'all' && ach.category !== activeAchievementTab) return false;
        }
        return ach.type !== 'private' || unlockedAchievements.has(ach.id);
    });

    const totalAchievements = achievementsArray.length;
    const unlockedCount = unlockedAchievements.size;

    const isDesktopView = !isMobileView && !isTabletView;

    // --- Conditional Styles ---
    const settingsModalStyle = {
        width: 'min(1200px, 90vw)',
        height: '85vh',
        maxHeight: '85vh',
        display: 'flex',
        flexDirection: 'column'
    };

    const settingsContentStyle = {
        display: 'flex',
        flexDirection: isMobileView ? 'column' : 'row',
        flexGrow: 1,
        overflow: 'hidden'
    };

    const sidebarStyle = {
        flexShrink: 0,
        display: 'flex',
        flexDirection: isMobileView ? 'row' : 'column',
        overflowX: isMobileView ? 'auto' : 'hidden',
        borderBottom: isMobileView ? '1px solid var(--border-color)' : 'none',
        borderRight: isMobileView ? 'none' : '1px solid var(--border-color)',
        padding: isMobileView ? '0' : '0 1rem 0 0',
        margin: isMobileView ? '0 0 0.5rem 0' : '0'
    };

    const mainContentStyle = {
        flexGrow: 1,
        overflowY: 'auto',
        padding: isDesktopView ? '0 1.5rem' : '0 1rem'
    };

    const tabButtonStyle = {
        whiteSpace: isMobileView ? 'nowrap' : 'normal',
        padding: isMobileView ? '0.6rem 0.8rem' : '0.5rem 1rem',
        fontSize: isMobileView ? '0.85rem' : '1rem'
    };

    const settingItemStyle = {
        flexDirection: isDesktopView ? 'row' : 'column',
        alignItems: isDesktopView ? 'center' : 'flex-start',
        gap: isDesktopView ? '1rem' : '0.5rem'
    };

    return (
        <div className="settings-overlay" onClick={onClose}>
            <div className="card settings-modal" style={settingsModalStyle} onClick={(e) => e.stopPropagation()}>
                <div className="settings-header">
                    <h2 style={{ margin: 0, fontSize: isDesktopView ? '1.5rem' : '1.1rem' }}>Ë®≠ÂÆö</h2>
                    
                </div>
                <div style={settingsContentStyle}>
                    <div style={sidebarStyle}>
                        <button
                            style={tabButtonStyle}
                            className={`settings-tab-button ${activeSettingsTab === 'achievements' ? 'active' : ''}`}
                            onClick={() => setActiveSettingsTab('achievements')}
                        >
                            ÂÆüÁ∏æ
                        </button>
                        <button
                            style={tabButtonStyle}
                            className={`settings-tab-button ${activeSettingsTab === 'data' ? 'active' : ''}`}
                            onClick={() => setActiveSettingsTab('data')}
                        >
                            „Éá„Éº„ÇøÁÆ°ÁêÜ
                        </button>
                        <button
                            style={tabButtonStyle}
                            className={`settings-tab-button ${activeSettingsTab === 'appearance' ? 'active' : ''}`}
                            onClick={() => setActiveSettingsTab('appearance')}
                        >
                            Â§ñË¶≥
                        </button>
                        <button
                            style={tabButtonStyle}
                            className={`settings-tab-button ${activeSettingsTab === 'about' ? 'active' : ''}`}
                            onClick={() => setActiveSettingsTab('about')}
                        >
                            „Åì„ÅÆ„Ç¢„Éó„É™„Å´„Å§„ÅÑ„Å¶
                        </button>
                        <button
                            style={tabButtonStyle}
                            className={`settings-tab-button ${activeSettingsTab === 'specialThanks' ? 'active' : ''}`}
                            onClick={() => setActiveSettingsTab('specialThanks')}
                        >
                            Special Thanks
                        </button>
                        <button
                            style={tabButtonStyle}
                            className={`settings-tab-button ${activeSettingsTab === 'profile' ? 'active' : ''}`}
                            onClick={() => setActiveSettingsTab('profile')}
                        >
                            „Éó„É≠„Éï„Ç£„Éº„É´
                        </button>
                    </div>
                    <div style={mainContentStyle}>
                        {activeSettingsTab === 'achievements' && (
                            <div>
                                <h3>ÂÆüÁ∏æ ({unlockedCount} / {totalAchievements})</h3>
                                <div className="achievement-tabs" style={{ display: 'flex', marginBottom: '1rem', borderBottom: '1px solid var(--border-color)' }}>
                                    {Object.entries(achievementCategories).map(([key, name]) => {
                                        const isActive = activeAchievementTab === key;
                                        const style = {
                                            padding: '0.5rem 1rem',
                                            border: 'none',
                                            background: isActive ? 'var(--bg-main)' : 'transparent',
                                            color: isActive ? 'var(--text-main)' : 'var(--text-subtle)',
                                            borderBottom: isActive ? '2px solid var(--primary-accent)' : '2px solid transparent',
                                            marginBottom: '-1px',
                                            cursor: 'pointer'
                                        };
                                        return (
                                            <button 
                                                key={key} 
                                                style={style}
                                                onClick={() => setActiveAchievementTab(key)}
                                            >
                                                {name}
                                            </button>
                                        );
                                    })}
                                </div>
                                <div className="achievement-list">
                                    {visibleAchievements.map(ach => {
                                        const isUnlocked = unlockedAchievements.has(ach.id);
                                        if (ach.type === 'secret' && !isUnlocked) {
                                            return (
                                                <div key={ach.id} className="achievement-item secret">
                                                    <div className="achievement-icon">‚ùì</div>
                                                    <div className="achievement-details">
                                                        <h4 className="achievement-name">{ach.name}</h4>
                                                        <p className="achievement-desc">ÔºüÔºüÔºü</p>
                                                    </div>
                                                </div>
                                            );
                                        } else {
                                            return (
                                                <div key={ach.id} className={`achievement-item ${isUnlocked ? 'unlocked' : ''}`}>
                                                    <div className="achievement-icon">{isUnlocked ? 'üèÜ' : 'üîí'}</div>
                                                    <div className="achievement-details">
                                                        <h4 className="achievement-name">{ach.name}</h4>
                                                        <p className="achievement-desc">{ach.description}</p>
                                                    </div>
                                                </div>
                                            );
                                        }
                                    })}
                                </div>
                            </div>
                        )}
                        {activeSettingsTab === 'data' && (
                            <div>
                                <h3>„Éá„Éº„ÇøÁÆ°ÁêÜ</h3>
                                <p>ÁèæÂú®„ÅÆ„Ç¢„Éó„É™„ÅÆÁä∂ÊÖãÔºàÊâÄÊåÅ„É°„ÇÆ„Éâ„ÄÅÁ∑®Êàê„ÄÅË®≠ÂÆö„Å™„Å©Ôºâ„Çí„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò„Åó„Åü„Çä„ÄÅ„Éï„Ç°„Ç§„É´„Åã„ÇâÂæ©ÂÖÉ„Åó„Åü„Çä„Åó„Åæ„Åô„ÄÇ</p>
                                <div className="settings-actions vertical">
                                    <button onClick={onExportData} className="btn btn-secondary">„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                                    <button onClick={onImportData} className="btn btn-secondary">„Ç§„É≥„Éù„Éº„Éà</button>
                                </div>
                                <h4 style={{marginTop: '32px', color: 'var(--danger-color)'}}>Âç±Èô∫„Å™Êìç‰Ωú</h4>
                                <div className="settings-actions">
                                     <button onClick={onResetAllData} className="btn btn-danger">ÂÖ®„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà</button>
                                </div>
                            </div>
                        )}
                        {activeSettingsTab === 'appearance' && (
                            <div>
                                <h3>Â§ñË¶≥</h3>
                                <div className="settings-actions vertical">
                                    <div className="setting-item" style={settingItemStyle}>
                                        <label htmlFor="theme-toggle">„ÉÜ„Éº„Éû</label>
                                        <button id="theme-toggle" onClick={onToggleTheme} className="btn btn-secondary">„É©„Ç§„Éà/„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàáÊõø</button>
                                    </div>

                                </div>
                            </div>
                        )}
                        {activeSettingsTab === 'about' && (
                            <div>
                                <h3>„Åì„ÅÆ„Ç¢„Éó„É™„Å´„Å§„ÅÑ„Å¶</h3>
                                <div className="about-section">
                                    <h4>„Éê„Éº„Ç∏„Éß„É≥</h4>
                                    <p>ver. 2025.09.09-Œ≤</p>
                                </div>
                                <div className="about-section">
                                    <h4>ÂÖçË≤¨‰∫ãÈ†Ö</h4>
                                    <p>ÂΩì„Çµ„Ç§„Éà„ÅØ„É°„ÇÆ„ÉâÔºóÔºí„ÅÆ„Ç≤„Éº„É†ÂÜÖ„ÄÅ„Ç≤„Éº„É†Â§ñ„ÅßÈÖçÂ∏É„Åï„Çå„ÅüÁîªÂÉè„ÄÅ„Éá„Éº„Çø„ÇíÂºïÁî®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ<br/>„Åì„Çå„Çâ„ÅÆËëó‰ΩúÊ®©„ÄÅÂïÜÊ®ôÊ®©„ÄÅ„Åù„ÅÆ‰ªñÁü•ÁöÑË≤°Áî£Ê®©„ÅØ„ÄÅÊ†™Âºè‰ºöÁ§æ„Éá„Ç£„Éº„Éª„Ç®„Éå„Éª„Ç®„Éº„Åä„Çà„Å≥„É°„Éá„Ç£„Ç¢„Éª„Éì„Ç∏„Éß„É≥Ê†™Âºè‰ºöÁ§æ„Å´Â∏∞Â±û„Åó„Åæ„Åô„ÄÇ</p>
                                    <p>ÂΩì„Çµ„Ç§„Éà„ÅØÂÄã‰∫∫„Éï„Ç°„É≥„Çµ„Ç§„Éà„Åß„ÅÇ„Çä„ÄÅÊ†™Âºè‰ºöÁ§æ„Éá„Ç£„Éº„Éª„Ç®„Éå„Éª„Ç®„Éº‰ªñ‰ºÅÊ•≠Êßò„Å®„ÅØ‰∏ÄÂàáÈñ¢‰øÇ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                                </div>
                                <div className="about-section">
                                    <h4>ÈÄ£Áµ°ÂÖà</h4>
                                    <div className="mail-subject-selector">
                                        <label>
                                            <input type="radio" name="mail_subject" value="‰∏çÂÖ∑ÂêàÂ†±Âëä" checked={mailSubject === '‰∏çÂÖ∑ÂêàÂ†±Âëä'} onChange={e => setMailSubject(e.target.value)} />
                                            ‰∏çÂÖ∑ÂêàÂ†±Âëä
                                        </label>
                                        <label>
                                            <input type="radio" name="mail_subject" value="Ë¶ÅÊúõ" checked={mailSubject === 'Ë¶ÅÊúõ'} onChange={e => setMailSubject(e.target.value)} />
                                            Ë¶ÅÊúõ
                                        </label>
                                        <label>
                                            <input type="radio" name="mail_subject" value="ÊÑüÊÉ≥" checked={mailSubject === 'ÊÑüÊÉ≥'} onChange={e => setMailSubject(e.target.value)} />
                                            ÊÑüÊÉ≥
                                        </label>
                                    </div>
                                    <p>
                                        <a href={`mailto:72corre+Tower_Tool@gmail.com?subject=${encodeURIComponent(`„ÄêÊòüÈñì„ÅÆÂ°î ÊîªÁï•ÊîØÊè¥„ÉÑ„Éº„É´„Äë${mailSubject}`)}`}>
                                            72corre+Tower_Tool@gmail.com
                                        </a>
                                    </p>
                                </div>
                                <div className="about-section">
                                    <h4>‰ΩøÁî®„É©„Ç§„Éñ„É©„É™</h4>
                                    <ul>
                                        <li>React</li>
                                        <li>qrious</li>
                                        <li>html5-qrcode</li>
                                        <li>Tailwind CSS</li>
                                    </ul>
                                </div>
                            </div>
                        )}
                        {activeSettingsTab === 'specialThanks' && (
                            <div>
                                <h3>Special Thanks</h3>
                                <div className="about-section">
                                    <p>Ôºà„Åì„Åì„Å´ÂçîÂäõËÄÖ„ÅÆ„ÅäÂêçÂâç„ÇíË®òËºâ„Åó„Åæ„ÅôÔºâ</p>
                                </div>
                            </div>
                        )}
                        {activeSettingsTab === 'profile' && (
                            <div>
                                <h3>„Éó„É≠„Éï„Ç£„Éº„É´</h3>
                                <p>„ÅÇ„Å™„Åü„ÅÆÊòüÈñì„ÅÆÂ°î„ÅÆÊîªÁï•Áä∂Ê≥Å„Çí„Åæ„Å®„ÇÅ„Åü„Éó„É≠„Éï„Ç£„Éº„É´ÁîªÂÉè„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ</p>
                                <div className="settings-actions vertical">
                                    <button onClick={onOpenProfileGenerator} className="btn btn-primary">„Éó„É≠„Éï„Ç£„Éº„É´ÁîªÂÉè„ÇíÁîüÊàê</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};